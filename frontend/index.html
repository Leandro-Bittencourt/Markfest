<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>MarkFest Demo</title>
    <style>
      body { font-family: Arial, sans-serif; padding: 20px; }
      input { margin:5px; }
      button { margin:5px; }
      pre { background:#f4f4f4; padding:10px; }
    </style>
  </head>
  <body>
    <h1>MarkFest Demo</h1>
    <h2>Auth</h2>
    <input id="email" placeholder="email" value="user@example.com"/>
    <input id="password" placeholder="password" value="senha123"/>
    <br/>
    <button id="btnReg">Register</button>
    <button id="btnLogin">Login</button>
    <pre id="out"></pre>
    <script>
      const out = document.getElementById('out');
      document.getElementById('btnReg').onclick = async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch('/auth-service/auth/register', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email,password})
        });
        out.innerText = await res.text();
      };
      document.getElementById('btnLogin').onclick = async () => {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch('/auth-service/auth/login', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({email,password})
        });
        out.innerText = JSON.stringify(await res.json(), null, 2);
      };
    </script>
  </body>
</html>
package com.markfest.participation.security;

import jakarta.servlet.FilterChain;
import jakarta.servlet.ServletException;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.security.Keys;
import org.springframework.web.filter.OncePerRequestFilter;

import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.security.Key;

public class JwtAuthFilter extends OncePerRequestFilter {
    private final Key key = Keys.hmacShaKeyFor("changeit-very-secret-key-change-this-in-prod-change".getBytes(StandardCharsets.UTF_8));

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws ServletException, IOException {
        String auth = request.getHeader("Authorization");
        if (auth != null && auth.startsWith("Bearer ")) {
            String token = auth.substring(7);
            try {
                Jwts.parserBuilder().setSigningKey(key).build().parseClaimsJws(token);
                // token vÃ¡lido -> prosseguir (pode extrair subject/claims aqui se precisar)
            } catch (Exception ex) {
                response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
                response.setContentType("application/json");
                response.getWriter().write("{\"error\":\"invalid token\"}");
                return;
            }
        } else {
            // sem Authorization: dependendo da rota, pode ser rejeitado pela SecurityConfig abaixo
        }
        filterChain.doFilter(request, response);
    }
}
